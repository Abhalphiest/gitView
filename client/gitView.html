<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Git Viewer</title>
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="js/fileExplorer.js"></script>
	<script src="js/previewNode.js"></script>
	<script src="test.js"></script>
	<script>
	var getCurrentRepo = (function(){
		const GITVIEW_URL = 'https://git-viewer.herokuapp.com/';
		const GITVIEW_TEST_URL = "http://localhost:3000/";
		window.onload = init;

		var repositories = [];
		var currentUsername = "";
		var currentRepo = undefined;
		
		function init(){
			// set up username search
			document.querySelector("#username").onchange = function(){
				queryUsername(this.value);
			};

			document.querySelector('#repositorySelect').onclick = function(){
				//if the repository list is populated, show it
				if(repositories.length != 0){
					$('#repositoryList').slideDown();
				}
			};


			document.querySelectorAll(".previewNode").forEach(function(node){
					node.addEventListener('contextmenu', function(e){
					e.preventDefault();
					previewNodeContextMenu(e.target,e.clientX, e.clientY);
					return false;
				});
			});

			document.onclick= function(){
				$('#dropdown').slideUp();
			};

			fileExplorer.initialize();
			previewNodeManager.initialize();

			fileExplorer.reset(testDir.fileDirectory);

			

		}
		
		function queryUsername(username){
			// get list of repositories
			console.log("querying username "+ username);
			//populate repositories
			var reposelect = document.querySelector("#repositoryList");

			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function(){
				if(this.readyState == 4 && this.status == 200){
					currentUsername = username;
					document.querySelector("#repositoryControl").style.opacity = 1.0; // make it visible if it was hidden
					reposelect.innerHTML = "";
					repositories = JSON.parse(this.responseText);
					for(let i = 0; i < repositories.length; i++){
						var li = document.createElement('li');
						li.innerText = repositories[i].name;
						li.value = i;
						li.onclick = selectRepository;
						reposelect.appendChild(li);
					}
				}
			};
			xhttp.open("GET", GITVIEW_TEST_URL + "user/repos?username="+username);
			xhttp.send();

		}

		function selectRepository(){
			var repo = repositories[this.value];
			currentRepo = repo;
			document.querySelector("#repositorySelect").innerText = repo.name;
			$('#repositoryList').slideUp();

			if(!repositories[this.value].fileDirectory){
				queryAdvancedData(repositories[this.value]);
			}
			else{
				fileExplorer.reset(repo.fileDirectory);
			}

			previewNodeManager.reset();
		}

		function queryAdvancedData(repo){
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function(){
				if(this.readyState == 4 && this.status == 200){
					console.dir(this.responseText);
					var advancedData = JSON.parse(this.responseText);
					repo.readme = advancedData.readme;
					repo.fileDirectory = advancedData.fileDirectory;
					repo.commitCount = advancedData.commitCount;
					repo.contributionPercentage = advancedData.contributionPercentage;
					fileExplorer.reset(repo.fileDirectory);
				}
					
			};
			xhttp.open("GET", GITVIEW_TEST_URL + "repo?username="+currentUsername +"&reponame="+repo.name+"&owner=" +repo.owner);
			xhttp.send();
		}

		function previewNodeContextMenu(node,x,y){
			console.log("clicked");
			var dropdown = document.querySelector("#dropdown");
			dropdown.style.left = x+"px";
			dropdown.style.top = y+"px";
			$('#dropdown').slideDown();
			dropdown.value = node.id;
		}
		
		return function getCurrentRepo(){return currentRepo};
	}());
	</script>
</head>
<body>


<!-- Top Bar -->
<section>
	<label for="username">GitHub Username: </label> <input type="text" id="username">
	<!-- Custom select -->
	<div id="repositoryControl">
		<div id="repositorySelect">
			<span id="currentRepo">Select a Repository</span>
		</div>
		<ul id="repositoryList"></ul>
	</div>
</section>


<!-- Preview Elements -->
<section id="layout">
<label for="layout"> Layout: </label> 	<ul id="layoutList"> 
											<li><img src="media/layout1.png" alt="layout 1"/></li>
											<li> 2 </li>
											<li> 3 </li>
											<li> 4 </li>
											<li> 5 </li>
											<li> 6 </li>
											<li> 7 </li>
											<li> 8 </li>
											<li> 9 </li>
										</ul>
</section>
	
<section id="preview"> 
	<div id="n1" class="previewNode" value="none"> </div>
	<div id="n2" class="previewNode" value="none"> </div>
	<div id="n3" class="previewNode" value="none"> </div>
	<div id="n4" class="previewNode" value="none"> </div>
	<div id="n5" class="previewNode" value="none"> </div>
</section>


<!-- File Explorer -->
<section id="fileExplorer">
	<div id="rootDir" class="directoryDiv">
	</div>
</section>

<!-- HTML/CSS/JS Code -->
<section id="codeGenerator"> 
	<div id="HTML"><label for="HTML"> HTML </label><div class="codeDisplay"> </div> </div>
	<div id="CSS"> <label for="CSS"> CSS </label><div class="codeDisplay"> </div></div>
	<div id="JS"> <label for="JS"> JavaScript </label><div class="codeDisplay"> </div></div>
</section>

<!-- Hidden elements (shown contextually) -->
<ul id="dropdown">
	<li id="titleFill">Title</li>
	<li id="titleDescripFill">Title &amp; Description</li>
	<li id="fileFill" >File</li>
	<li id="fileListFill" >File List</li>
	<li id="readmeFill" >Readme</li>
	<li id="contributionsFill" >Contributions</li>
	<li id="imageFill" >Image</li>
	<li id="editNode">Edit</li>
</ul>

<div id="overlay"> </div>
<section id="textEditor">
	<input type="text" id="textField">
	<div id="editorOptions"> 

	</div>
</section>
</body>
</html>
