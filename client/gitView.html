<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Git Viewer</title>
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script>
	(function(){
		const GITVIEW_URL = 'https://git-viewer.herokuapp.com/';
		const GITVIEW_TEST_URL = "http://localhost:3000/";
		window.onload = init;

		var repositories = [];
		var currentUsername = "";
		
		function init(){
			// set up username search
			document.querySelector("#username").onchange = function(){
				queryUsername(this.value);
			};

			document.querySelector('#repositorySelect').onclick = function(){
				//if the repository list is populated, show it
				if(repositories.length != 0){
					$('#repositoryList').slideDown();
				}
			};


			document.querySelectorAll(".previewNode").forEach(function(node){
					node.addEventListener('contextmenu', function(e){
					e.preventDefault();
					previewNodeContextMenu(e.target,e.clientX, e.clientY);
					return false;
				});
			});

			document.onclick= function(){
				$('#dropdown').slideUp();
			};

		}
		
		function queryUsername(username){
			// get list of repositories
			console.log("querying username "+ username);
			//populate repositories
			var reposelect = document.querySelector("#repositoryList");

			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function(){
				if(this.readyState == 4 && this.status == 200){
					currentUsername = username;
					document.querySelector("#repositoryControl").style.opacity = 1.0; // make it visible if it was hidden
					console.dir(this.responseText);
					repositories = JSON.parse(this.responseText);
					for(let i = 0; i < repositories.length; i++){
						var li = document.createElement('li');
						li.innerText = repositories[i].name;
						li.value = i;
						li.onclick = selectRepository;
						reposelect.appendChild(li);
					}
				}
			};
			xhttp.open("GET", GITVIEW_URL + "user/repos?username="+username);
			console.log(GITVIEW_URL + "user/repos?username="+username);
			xhttp.send();

		}

		// hard coded for now
		function selectRepository(){
			var repo = repositories[this.value];
			document.querySelector("#repositorySelect").innerText = repo.name;
			$('#repositoryList').slideUp();

			if(!repositories[this.value].fileDirectory){
				queryAdvancedData(repositories[this.value]);
			}

			document.querySelector("#n1").innerText = repo.name + "\n" + repo.description;
			document.querySelector("#n5").innerText = "Language: " + repo.language + "\nLast Updated: " + repo.lastUpdated;
		}

		function queryAdvancedData(repo){
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function(){
				if(this.readyState == 4 && this.status == 200){
					console.dir(this.responseText);
					var advancedData = JSON.parse(this.responseText);
					repo.readme = advancedData.readme;
					repo.fileDirectory = advancedData.fileDirectory;
					repo.commitCount = advancedData.commitCount;
					repo.contributionPercentage = advancedData.contributionPercentage;

				}
					
			};
			xhttp.open("GET", GITVIEW_URL + "repo?username="+currentUsername +"&reponame="+repo.name+"&owner=" +repo.owner);
			xhttp.send();
		}

		function changeLayout(layout){

		}

		function previewNodeContextMenu(node,x,y){
			console.log("clicked");
			var dropdown = document.querySelector("#dropdown");
			dropdown.style.left = x+"px";
			dropdown.style.top = y+"px";
			$('#dropdown').slideDown();
		}
		
	
	}())
	</script>
</head>
<body>

<div>
	<label for="username">GitHub Username: </label> <input type="text" id="username">
	<!-- Custom select -->
	<div id="repositoryControl">
		<div id="repositorySelect">
			<span id="currentRepo">Select a Repository</span>
		</div>
		<ul id="repositoryList"></ul>
	</div>
</div>
<div id="layout">
<label for="layout"> Layout: </label> 	<ul id="layoutList"> 
											<li><img src="media/layout1.png" alt="layout 1"/></li>
											<li> 2 </li>
											<li> 3 </li>
											<li> 4 </li>
											<li> 5 </li>
											<li> 6 </li>
											<li> 7 </li>
											<li> 8 </li>
											<li> 9 </li>
										</ul>
</div>
	
<div id="preview"> 
	<div id="n1" class="previewNode"> </div>
	<div id="n2" class="previewNode"> </div>
	<div id="n3" class="previewNode"> </div>
	<div id="n4" class="previewNode"> </div>
	<div id="n5" class="previewNode"> </div>
</div>

<ul id="dropdown"><li> This is a dropdown </li></ul>
</body>
</html>
